<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Class Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-neutral-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
      <h1 class="text-3xl font-bold text-white mb-6">Class Booking</h1>

      <form
        method="POST"
        action="/book"
        class="bg-white p-6 rounded-lg shadow-md space-y-4"
      >
        <div>
          <label for="trainer" class="block text-gray-700 font-semibold mb-2"
            >Trainer</label
          >
          <select
            id="trainer"
            name="trainer"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
            >
            <option value="Daniel Smith" data-id="1">Daniel Smith</option>
            <option value="Emma Wilson" data-id="2">Emma Wilson</option>
            <option value="John Carte" data-id="3">John Carter</option>
            <option value="Michael Brown" data-id="4">Michael Brown</option>
            <option value="Sophia Miller" data-id="5">Sophia Miller</option>
            </select> 
             <!--Class-->
          <label for="class" class="block text-gray-700 font-semibold mb-2"
            >Class</label
          >
          <input
            id="class"
            name="class"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            readonly
          />
        </div>
        <!--Price-->
            <div>
             <label for="price" class="block text-gray-700 font-semibold mb-2"
              >Price (THB)</label
             >
             <input
               id="price"
              name="price"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              readonly
          />
        </div>
        
        <!-- Date (Native Picker) -->
        <div>
          <label for="date" class="block text-gray-700 font-semibold mb-2">Date</label>
          <input
            id="date"
            name="date"
            type="date"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!--Time-->
        <div>
          <label for="timeSlot" class="block text-gray-700 font-semibold mb-2"
            >Time</label
          >
          <select
            id="timeSlot"
            name="timeSlot"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="">Choose a time</option>
          </select> <!--เลือกเวลา--> 
          <div id="scheduleNote" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <input type="hidden" name="trainerId" id="trainerId" />
        <input type="hidden" name="classId" id="classId" />

        <button
          id="bookBtn"
          class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
          style="margin-top: 12px"
        >
          Book Now
        </button>
      </form>

      <p class="mt-4">
        <a href="/trainers.html" class="text-blue-500 hover:underline"
          >← Back to class</a 
        >
      </p>
    </div>

    <script>
      // ----------------- Helpers -----------------
      function qp(key) {
        return new URLSearchParams(location.search).get(key) || "";
      }
      function toISODate(d) {
        return d.toISOString().slice(0, 10);
      }
      function parseISODate(s) {
        const [y, m, d] = s.split("-").map(Number);
        return new Date(y, m - 1, d);
      }
      function weekdayKeyFromDateStr(iso) {
        return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][
          parseISODate(iso).getDay()
        ];
      }

      // ----------------- Get available dates -----------------
      function getAvailableDates(sched, maxDays = 90) {
        const dates = [];
        let d = new Date();
        for (let i = 0; i < maxDays; i++) {
          const iso = toISODate(d);
          const wk = weekdayKeyFromDateStr(iso);
          if (sched[wk] && sched[wk].length) {
            dates.push(iso);
          }
          d.setDate(d.getDate() + 1);
        }
        return dates;
      }

      // ----------------- UI fillers -----------------
      function fillDateOptions(sched) {
        const dateSel = document.getElementById("date");
        const availableDates = getAvailableDates(sched);
        availableDates.forEach((iso) => {
          const opt = document.createElement("option");
          opt.value = iso;
          const d = parseISODate(iso);
          const day = weekdayKeyFromDateStr(iso);
          const date = d.getDate();
          const month = d.toLocaleString("en", { month: "short" });
          const year = d.getFullYear();
          opt.textContent = `${day} ${date} ${month} ${year}`;
          dateSel.appendChild(opt);
        });
        return availableDates;
      }

      function fillTimeOptionsForDate(sched, isoDate) {
        const timeSel = document.getElementById("timeSlot");
        const note = document.getElementById("scheduleNote");
        const btn = document.getElementById("bookBtn");

        timeSel.innerHTML = '<option value="">Choose a time</option>';

        const wk = weekdayKeyFromDateStr(isoDate);
        const slots = sched[wk] || [];

        if (slots.length) {
          slots.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            timeSel.appendChild(opt);
          });
          note.textContent = `Available on ${wk}: ${slots.join(", ")}`;
          btn.disabled = false;
          btn.style.opacity = 1;
        } else {
          note.textContent = `No classes on this day.`;
          btn.disabled = true;
          btn.style.opacity = 0.6;
        }
      }

      // ----------------- Init -----------------
      document.addEventListener("DOMContentLoaded", async () => {
        let trainerName = qp("trainer");
        let className = qp("class");
        let price = qp("price");
        let dateQ = qp("date");
        let timeQ = qp("time");
        let trainerId = qp("trainerId");
        let classId = qp("classId");

        // เซ็ตค่าเริ่มต้นในฟอร์ม
        const trainerSelect = document.getElementById("trainer");
        const trainerOption = Array.from(trainerSelect.options).find(opt => opt.value === trainerName);
        if (trainerOption) {
          trainerSelect.value = trainerName;
          document.getElementById("trainerId").value = trainerOption.getAttribute("data-id");
        }

        document.getElementById("class").value = className;
        document.getElementById("price").value = price;
        document.getElementById("classId").value = classId;

  // อัปเดต trainerId เมื่อเปลี่ยนชื่อ Trainer
        trainerSelect.addEventListener("change", (e) => {
        const selectedOption = e.target.selectedOptions[0];
        const trainerName = selectedOption.value;
        const trainerId = selectedOption.getAttribute("data-id");
        document.getElementById("trainerId").value = trainerId;
        });


        // Fetch trainer schedule from DB
        let sched = {};
        try {
          const response = await fetch("/api/trainers");
          const trainers = await response.json();
          const trainer = trainers.find((t) => t.name === trainerName);
          if (trainer && trainer.schedule) {
            trainer.schedule.forEach((slot) => {
              const [day, time] = slot.split(" ");
              if (!sched[day]) sched[day] = [];
              sched[day].push(time);
            });
          }
        } catch (err) {
          console.error("Failed to fetch trainer schedule:", err);
        }

        const availableDates = fillDateOptions(sched);

        let defaultISO = dateQ;
        if (!defaultISO || !availableDates.includes(defaultISO)) {
          defaultISO = availableDates[0] || "";
        }
        document.getElementById("date").value = defaultISO;

        if (defaultISO) {
          fillTimeOptionsForDate(sched, defaultISO);
          if (timeQ) {
            const sel = document.getElementById("timeSlot");
            const has = Array.from(sel.options).some((o) => o.value === timeQ);
            if (has) sel.value = timeQ;
          }
        }

        // Refresh time slots when the date changes
        document.getElementById("date").addEventListener("change", (e) => {
          fillTimeOptionsForDate(sched, e.target.value);
        });
      });
    </script>
  </body>
</html>
