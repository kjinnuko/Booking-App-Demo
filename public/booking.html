<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Class Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-neutral-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
      <h1 class="text-3xl font-bold text-white mb-6">Class Booking</h1>

      <form method="POST" action="/book" class="bg-white p-6 rounded-lg shadow-md space-y-4">
        <div>
          <label for="trainer" class="block text-gray-700 font-semibold mb-2">Trainer</label>
          <select
            id="trainer"
            name="trainer"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="Daniel Smith" data-id="1">Daniel Smith</option>
            <option value="Emma Wilson" data-id="2">Emma Wilson</option>
            <option value="John Carter" data-id="3">John Carter</option>
            <option value="Michael Brown" data-id="4">Michael Brown</option>
            <option value="Sophia Miller" data-id="5">Sophia Miller</option>
          </select>

          <!-- Class -->
          <label for="class" class="block text-gray-700 font-semibold mb-2 mt-4">Class</label>
          <input
            id="class"
            name="class"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            readonly
          />
        </div>

        <!-- Price -->
        <div>
          <label for="price" class="block text-gray-700 font-semibold mb-2">Price (THB)</label>
          <input
            id="price"
            name="price"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            readonly
          />
        </div>

        <!-- Date (Native Picker) -->
        <div>
          <label for="date" class="block text-gray-700 font-semibold mb-2">Date</label>
          <input
            id="date"
            name="date"
            type="date"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p id="dateHelp" class="text-xs text-gray-500 mt-1">Only dates that match the trainer’s weekly schedule will show time slots.</p>
        </div>

        <!-- Time -->
        <div>
          <label for="timeSlot" class="block text-gray-700 font-semibold mb-2">Time</label>
          <select
            id="timeSlot"
            name="timeSlot"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="">Choose a time</option>
          </select>
          <div id="scheduleNote" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <input type="hidden" name="trainerId" id="trainerId" />
        <input type="hidden" name="classId" id="classId" />

        <button
          id="bookBtn"
          class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
          style="margin-top: 12px"
        >
          Book Now
        </button>
      </form>

      <p class="mt-4">
        <a href="/trainers.html" class="text-blue-500 hover:underline">← Back to class</a>
      </p>
    </div>

    <script>
      // ----------------- Helpers -----------------
      function qp(key) {
        return new URLSearchParams(location.search).get(key) || "";
      }
      function toISODateLocal(d) {
        // Local date -> YYYY-MM-DD (เลี่ยง timezone ทำให้วันเพี้ยน)
        const tz = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - tz).toISOString().slice(0, 10);
      }
      function parseISODate(s) {
        const [y, m, d] = s.split("-").map(Number);
        return new Date(y, m - 1, d);
      }
      function weekdayKeyFromDateStr(iso) {
        return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][parseISODate(iso).getDay()];
      }

      // ----------------- Schedule utils -----------------
      function normalizeDayToAbbrev(token) {
        if (!token) return "";
        const t = token.toString().trim().toLowerCase();
        const map = {
          sun: "Sun", sunday: "Sun",
          mon: "Mon", monday: "Mon",
          tue: "Tue", tues: "Tue", tuesday: "Tue",
          wed: "Wed", weds: "Wed", wednesday: "Wed",
          thu: "Thu", thur: "Thu", thurs: "Thu", thursday: "Thu",
          fri: "Fri", friday: "Fri",
          sat: "Sat", saturday: "Sat",
        };
        return map[t] || map[t.slice(0,3)] || "";
      }

      // schedule -> บังคับเป็น Array เสมอ (รองรับ Array / String(JSON) / Object)
      function coerceScheduleToArray(raw) {
        if (Array.isArray(raw)) return raw;
        if (typeof raw === "string") {
          try { return JSON.parse(raw); } catch { return []; }
        }
        if (raw && typeof raw === "object") {
          const out = [];
          for (const k of Object.keys(raw)) {
            const day = normalizeDayToAbbrev(k);
            const v = raw[k];
            if (Array.isArray(v)) v.forEach(t => typeof t === "string" && out.push(`${day} ${t}`));
            else if (typeof v === "string") out.push(`${day} ${v}`);
          }
          return out;
        }
        return [];
      }

      // parser แบบ "หลวม" (ทนทานเหมือนหน้า Confirm)
      function buildWeekScheduleLoose(trainer) {
        const sched = {};
        if (!trainer) return sched;

        const arr = coerceScheduleToArray(trainer.schedule);

        arr.forEach((slot) => {
          if (typeof slot !== "string") return;

          // รวม dash แปลกๆ → "-" และจัดช่องว่าง
          const s = slot
            .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g, "-")
            .replace(/\s+/g, " ")
            .trim();

          // แยกด้วยช่องว่างแรก: "Mon 09:00-11:00" → "Mon" | "09:00-11:00"
          const i = s.indexOf(" ");
          if (i < 0) return;

          const day = normalizeDayToAbbrev(s.slice(0, i));
          const time = s.slice(i + 1);

          if (!day || !time) return;
          if (!sched[day]) sched[day] = [];
          sched[day].push(time);
        });

        return sched;
      }

      // วันที่ล่วงหน้า (ที่มีคลาสจริง) 90 วัน
      function getAvailableDates(sched, maxDays = 90) {
        const dates = [];
        let d = new Date();
        for (let i = 0; i < maxDays; i++) {
          const iso = toISODateLocal(d);
          const wk = weekdayKeyFromDateStr(iso);
          if (sched[wk] && sched[wk].length) dates.push(iso);
          d.setDate(d.getDate() + 1);
        }
        return dates;
      }

      function fillDateOptions(sched) {
        const dateInput = document.getElementById("date");
        // ใส่ min/max เพื่อช่วย UX
        const today = new Date();
        const max = new Date();
        max.setDate(today.getDate() + 90);
        dateInput.min = toISODateLocal(today);
        dateInput.max = toISODateLocal(max);

        const availableDates = getAvailableDates(sched);
        // ถ้าวันที่ปัจจุบันไม่ตรงตาราง ให้ใส่วันแรกที่ตรง
        const first = availableDates[0] || "";
        if (first) dateInput.value = first;
        return availableDates;
      }

      function fillTimeOptionsForDate(sched, isoDate) {
        const timeSel = document.getElementById("timeSlot");
        const note = document.getElementById("scheduleNote");
        const btn = document.getElementById("bookBtn");

        timeSel.innerHTML = '<option value="">Choose a time</option>';

        if (!isoDate) {
          note.textContent = "Please pick a date.";
          btn.disabled = true;
          return;
        }

        const wk = weekdayKeyFromDateStr(isoDate);
        const slots = sched[wk] || [];

        if (slots.length) {
          slots.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            timeSel.appendChild(opt);
          });
          note.textContent = `Available on ${wk}: ${slots.join(", ")}`;
          btn.disabled = false;
        } else {
          note.textContent = `No classes on this day.`;
          btn.disabled = true;
        }
      }

      function setLoading(isLoading){
        const bookBtn = document.getElementById("bookBtn");
        const timeSel = document.getElementById("timeSlot");
        const note    = document.getElementById("scheduleNote");
        if (isLoading){
          bookBtn.disabled = true;
          timeSel.disabled = true;
          timeSel.innerHTML = '<option value="">Loading…</option>';
          note.textContent = "Loading schedule…";
        } else {
          timeSel.disabled = false;
          if (!timeSel.options.length) {
            timeSel.innerHTML = '<option value="">Choose a time</option>';
          }
          note.textContent = "";
        }
      }

      async function fetchTrainers() {
        const res = await fetch("/api/trainers");
        if (!res.ok) throw new Error("Failed to load trainers");
        return res.json();
      }

      async function init() {
        setLoading(true);

        // Query params
        let trainerName = qp("trainer");
        let className   = qp("class");
        let price       = qp("price");
        let dateQ       = qp("date");
        let timeQ       = qp("time");
        let classId     = qp("classId");

        // set defaults/hidden
        const trainerSelect = document.getElementById("trainer");
        if (trainerName) {
          const trainerOption = Array.from(trainerSelect.options).find((opt) => opt.value === trainerName);
          if (trainerOption) {
            trainerSelect.value = trainerName;
            document.getElementById("trainerId").value = trainerOption.getAttribute("data-id");
          }
        } else {
          document.getElementById("trainerId").value = trainerSelect.selectedOptions[0].getAttribute("data-id");
          trainerName = trainerSelect.value;
        }
        document.getElementById("class").value = className || "";
        document.getElementById("price").value = price || "";
        document.getElementById("classId").value = classId || "";

        // โหลด trainers + สร้าง schedule แบบหลวม
        let sched = {};
        try {
          const trainers = await fetchTrainers();
          const trainer = trainers.find((t) => t.name === trainerName);
          sched = buildWeekScheduleLoose(trainer);
        } catch (e) {
          console.error("Failed to fetch trainer schedule:", e);
          sched = {};
        }

        // เติมวันและเวลา
        const availableDates = fillDateOptions(sched);

        let defaultISO = dateQ;
        if (!defaultISO || !availableDates.includes(defaultISO)) {
          defaultISO = availableDates[0] || "";
        }
        document.getElementById("date").value = defaultISO;

        if (defaultISO) {
          fillTimeOptionsForDate(sched, defaultISO);
          if (timeQ) {
            const sel = document.getElementById("timeSlot");
            const has = Array.from(sel.options).some((o) => o.value === timeQ);
            if (has) sel.value = timeQ;
          }
        }

        // เมื่อเปลี่ยนวัน → เติมเวลาใหม่
        document.getElementById("date").addEventListener("change", (e) => {
          fillTimeOptionsForDate(sched, e.target.value);
        });

        // เปลี่ยนเทรนเนอร์ → โหลดตารางใหม่
        trainerSelect.addEventListener("change", async (e) => {
          setLoading(true);
          const selectedOption = e.target.selectedOptions[0];
          document.getElementById("trainerId").value = selectedOption.getAttribute("data-id");
          const name = selectedOption.value;

          let newSched = {};
          try {
            const trainers = await fetchTrainers();
            const trainer = trainers.find((t) => t.name === name);
            newSched = buildWeekScheduleLoose(trainer);
          } catch (err) {
            console.error("Failed to fetch trainer schedule:", err);
            newSched = {};
          }

          const avail = fillDateOptions(newSched);
          const first = avail[0] || "";
          document.getElementById("date").value = first;
          fillTimeOptionsForDate(newSched, first);
          document.getElementById("timeSlot").value = "";
          setLoading(false);
        });

        setLoading(false);
      }

      document.addEventListener("DOMContentLoaded", () => { init(); });
    </script>
  </body>
</html>
