<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Class Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-neutral-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
      <h1 class="text-3xl font-bold text-white mb-6">Class Booking</h1>

      <form method="POST" action="/book" class="bg-white p-6 rounded-lg shadow-md space-y-4">
        <div>
          <label for="trainer" class="block text-gray-700 font-semibold mb-2">Trainer</label>
          <select
            id="trainer"
            name="trainer"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="Daniel Smith" data-id="1">Daniel Smith</option>
            <option value="Emma Wilson" data-id="2">Emma Wilson</option>
            <option value="John Carter" data-id="3">John Carter</option>
            <option value="Michael Brown" data-id="4">Michael Brown</option>
            <option value="Sophia Miller" data-id="5">Sophia Miller</option>
          </select>

          <!-- Class -->
          <label for="class" class="block text-gray-700 font-semibold mb-2 mt-4">Class</label>
          <input
            id="class"
            name="class"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            readonly
          />
        </div>

        <!-- Price -->
        <div>
          <label for="price" class="block text-gray-700 font-semibold mb-2">Price (THB)</label>
          <input
            id="price"
            name="price"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            readonly
          />
        </div>

        <!-- Date (Native Picker) -->
        <div>
          <label for="date" class="block text-gray-700 font-semibold mb-2">Date</label>
          <input
            id="date"
            name="date"
            type="date"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p id="dateHelp" class="text-xs text-gray-500 mt-1">Only dates that match the trainer‚Äôs weekly schedule will show time slots.</p>
        </div>

        <!-- Time -->
        <div>
          <label for="timeSlot" class="block text-gray-700 font-semibold mb-2">Time</label>
          <select
            id="timeSlot"
            name="timeSlot"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="">Choose a time</option>
          </select>
          <div id="scheduleNote" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <input type="hidden" name="trainerId" id="trainerId" />
        <input type="hidden" name="classId" id="classId" />

        <button
          id="bookBtn"
          class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
          style="margin-top: 12px"
        >
          Book Now
        </button>
      </form>

      <p class="mt-4">
        <a href="/trainers.html" class="text-blue-500 hover:underline">‚Üê Back to class</a>
      </p>
    </div>

    <script>
      // ----------------- Helpers -----------------
      function qp(key) {
        return new URLSearchParams(location.search).get(key) || "";
      }
      function toISODate(d) {
        // local date -> YYYY-MM-DD
        const tzOffset = d.getTimezoneOffset() * 60000;
        const local = new Date(d.getTime() - tzOffset);
        return local.toISOString().slice(0, 10);
      }
      function parseISODate(s) {
        const [y, m, d] = s.split("-").map(Number);
        return new Date(y, m - 1, d);
      }
      function weekdayKeyFromDateStr(iso) {
        return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][parseISODate(iso).getDay()];
      }

      // ----------------- Schedule utils -----------------
       function normalizeDayToAbbrev(token) {
    if (!token) return "";
    const t = token.toString().trim().toLowerCase();
    const map = {
      sun: "Sun", sunday: "Sun",
      mon: "Mon", monday: "Mon",
      tue: "Tue", tues: "Tue", tuesday: "Tue",
      wed: "Wed", weds: "Wed", wednesday: "Wed",
      thu: "Thu", thur: "Thu", thurs: "Thu", thursday: "Thu",
      fri: "Fri", friday: "Fri",
      sat: "Sat", saturday: "Sat",
    };
    // ‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏Å
    return map[t] || map[t.slice(0,3)] || "";
  }
function coerceScheduleToArray(raw) {
    let v = raw;

    // ‡∏ñ‡πâ‡∏≤ backend ‡∏™‡πà‡∏á JSON ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ parse ‡∏Å‡πà‡∏≠‡∏ô
    if (typeof v === "string") {
      try { v = JSON.parse(v); } catch { /* ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ */ }
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô object (map ‡∏ß‡∏±‡∏ô -> ‡πÄ‡∏ß‡∏•‡∏≤/array‡πÄ‡∏ß‡∏•‡∏≤) ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
    if (v && typeof v === "object" && !Array.isArray(v)) {
      const out = [];
      for (const key of Object.keys(v)) {
        const day = normalizeDayToAbbrev(key);
        if (!day) continue;
        const val = v[key];
        if (Array.isArray(val)) {
          val.forEach(t => {
            if (typeof t === "string") out.push(`${day} ${t}`);
          });
        } else if (typeof val === "string") {
          out.push(`${day} ${val}`);
        }
      }
      return out;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô array ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
    if (Array.isArray(v)) return v;

    // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô array ‡∏ß‡πà‡∏≤‡∏á
    return [];
  }

  // ‚úÖ ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô ‚Äú‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏™‚Äù ‡∏Ç‡∏≠‡∏á buildWeekSchedule
  function buildWeekSchedule(trainer) {
    const sched = {};
    if (!trainer) return sched;

    // 1) ‡∏î‡∏∂‡∏á schedule ‡∏à‡∏≤‡∏Å trainer ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô array ‡πÄ‡∏™‡∏°‡∏≠
    const arr = coerceScheduleToArray(trainer.schedule);

    // 2) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå dash ‡πÅ‡∏•‡∏∞ whitespace ‡πÅ‡∏•‡πâ‡∏ß parse
    arr.forEach((slotRaw) => {
      if (typeof slotRaw !== "string") return;

      // EN DASH ‚Üí hyphen ‡πÅ‡∏•‡∏∞ normalize ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
      let s = slotRaw.replace(/\u2013/g, "-").replace(/\s+/g, " ").trim();

      // ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö Mon/Monday + ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ö '-'
      // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:  "Mon 09:00-11:00"
      const m = s.match(/^([A-Za-z]+)\s+([0-2]\d:[0-5]\d)\s*-\s*([0-2]\d:[0-5]\d)$/);
      if (!m) {
        console.warn("Unmatched schedule entry:", slotRaw, "‚Üí normalized:", s);
        return;
      }

      const dayAbbrev = normalizeDayToAbbrev(m[1]);
      if (!dayAbbrev) return;

      const timeStr = `${m[2]}-${m[3]}`;
      if (!sched[dayAbbrev]) sched[dayAbbrev] = [];
      sched[dayAbbrev].push(timeStr);
    });

    // üëÄ ‡∏ä‡πà‡∏ß‡∏¢ debug
    // console.log("BUILT SCHEDULE ‚Üí", sched, "(raw:", trainer.schedule, ")");
    return sched;
  }
      function getFirstAvailableDate(sched, maxDays = 90, preferISO) {
        const today = new Date();
        for (let i = 0; i < maxDays; i++) {
          const d = new Date(today);
          d.setDate(today.getDate() + i);
          const iso = toISODate(d);
          const wk = weekdayKeyFromDateStr(iso);
          if (sched[wk] && sched[wk].length) {
            if (!preferISO || preferISO === iso) return iso;
          }
        }
        return ""; // none found
      }

      function refreshTimeOptionsForDate(sched, isoDate) {
        const timeSel = document.getElementById("timeSlot");
        const note = document.getElementById("scheduleNote");
        const btn = document.getElementById("bookBtn");

        timeSel.innerHTML = '<option value="">Choose a time</option>';

        if (!isoDate) {
          note.textContent = "Please pick a date.";
          btn.disabled = true;
          return;
        }

        const wk = weekdayKeyFromDateStr(isoDate);
        const slots = sched[wk] || [];

        if (slots.length) {
          slots.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            timeSel.appendChild(opt);
          });
          note.textContent = `Available on ${wk}: ${slots.join(", ")}`;
          btn.disabled = false;
        } else {
          note.textContent = `No classes on this day.`;
          btn.disabled = true;
        }
      }

      async function fetchTrainers() {
        const res = await fetch("/api/trainers");
        if (!res.ok) throw new Error("Failed to load trainers");
        return res.json();
      }

      async function loadScheduleAndRefresh(trainerName, preferredISO, preferredTime) {
        // Load trainers, find selected one, build sched
        let sched = {};
        try {
          const trainers = await fetchTrainers();
          const trainer = trainers.find((t) => t.name === trainerName);
          sched = buildWeekSchedule(trainer);
        } catch (e) {
          console.error("Failed to fetch trainer schedule:", e);
          sched = {};
        }

        // Decide default date (prefer query date if valid)
        let defaultISO = preferredISO;
        if (defaultISO) {
          const wk = weekdayKeyFromDateStr(defaultISO);
          if (!sched[wk] || !sched[wk].length) {
            defaultISO = ""; // not valid for this trainer
          }
        }
        if (!defaultISO) {
          defaultISO = getFirstAvailableDate(sched, 90);
        }

        const dateInput = document.getElementById("date");
        dateInput.value = defaultISO || "";

        // Optional min/max to help UX (today .. +90d)
        const today = new Date();
        const max = new Date();
        max.setDate(today.getDate() + 90);
        dateInput.min = toISODate(today);
        dateInput.max = toISODate(max);

        refreshTimeOptionsForDate(sched, dateInput.value);

        // if a preferred time was passed (e.g., from URL), keep it if valid
        if (preferredTime) {
          const sel = document.getElementById("timeSlot");
          const has = Array.from(sel.options).some((o) => o.value === preferredTime);
          if (has) sel.value = preferredTime;
        }

        // Hook date change to update times
        dateInput.onchange = (e) => {
          refreshTimeOptionsForDate(sched, e.target.value);
        };
      }

      // ----------------- Init -----------------
      document.addEventListener("DOMContentLoaded", async () => {
        const trainerSelect = document.getElementById("trainer");

        // Read query params
        let trainerName = qp("trainer");
        let className = qp("class");
        let price = qp("price");
        let dateQ = qp("date");
        let timeQ = qp("time");
        let classId = qp("classId");

        // Set form fields
        if (trainerName) {
          const trainerOption = Array.from(trainerSelect.options).find((opt) => opt.value === trainerName);
          if (trainerOption) {
            trainerSelect.value = trainerName;
            document.getElementById("trainerId").value = trainerOption.getAttribute("data-id");
          }
        } else {
          // default to current selection
          document.getElementById("trainerId").value = trainerSelect.selectedOptions[0].getAttribute("data-id");
          trainerName = trainerSelect.value;
        }

        document.getElementById("class").value = className || "";
        document.getElementById("price").value = price || "";
        document.getElementById("classId").value = classId || "";

        // When trainer changes, update hidden id and reload schedule/date/time
        trainerSelect.addEventListener("change", async (e) => {
          const selectedOption = e.target.selectedOptions[0];
          document.getElementById("trainerId").value = selectedOption.getAttribute("data-id");
          await loadScheduleAndRefresh(selectedOption.value, "", "");
          // clear previously chosen time
          document.getElementById("timeSlot").value = "";
        });

        // Initial load with URL preferences (if any)
        await loadScheduleAndRefresh(trainerName, dateQ, timeQ);
      });
    </script>
  </body>
</html>
