<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Class Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-neutral-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
      <h1 class="text-3xl font-bold text-white mb-6">Class Booking</h1>

      <form method="POST" action="/book" class="bg-white p-6 rounded-lg shadow-md space-y-4">
        <div>
          <label for="trainer" class="block text-gray-700 font-semibold mb-2">Trainer</label>
          <select
            id="trainer"
            name="trainer"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="John Carter" data-id="1">John Carter</option>
            <option value="Sophia Miller" data-id="2">Sophia Miller</option>
            <option value="Michael Brown" data-id="3">Michael Brown</option>
            <option value="Emma Wilson" data-id="4">Emma Wilson</option>
            <option value="Daniel Smith" data-id="5">Daniel Smith</option>
          </select>

          <!-- Class -->
          <label for="class" class="block text-gray-700 font-semibold mb-2 mt-4">Class</label>
          <input
            id="class"
            name="class"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            readonly
          />
        </div>

        <!-- Price -->
        <div>
          <label for="price" class="block text-gray-700 font-semibold mb-2">Price (THB)</label>
          <input
            id="price"
            name="price"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            readonly
          />
        </div>

        <!-- Date -->
        <div>
          <label for="date" class="block text-gray-700 font-semibold mb-2">Date</label>
          <input
            id="date"
            name="date"
            type="date"
            min=""
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">Only dates that match the trainer’s weekly schedule will show time slots.</p>
        </div>

        <!-- Time -->
        <div>
          <label for="timeSlot" class="block text-gray-700 font-semibold mb-2">Time</label>
          <select
            id="timeSlot"
            name="timeSlot"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="">Choose a time</option>
          </select>
          <div id="scheduleNote" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <input type="hidden" name="trainerId" id="trainerId" />
        <input type="hidden" name="classId" id="classId" />

        <button
          id="bookBtn"
          class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
          style="margin-top: 12px"
        >
          Book Now
        </button>
      </form>

      <p class="mt-4">
        <a href="/trainers.html" class="text-blue-500 hover:underline">← Back to class</a>
      </p>
    </div>

<div id="dupModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50"></div>
  <div class="relative mx-auto mt-24 w-[92%] max-w-md rounded-xl bg-white p-6 shadow-xl">
    <h3 class="text-lg font-semibold text-gray-900">Duplicate booking</h3>
    <p id="dupMsg" class="mt-2 text-gray-700">
      You already have a booking at this time.
    </p>
    <div class="mt-6 flex justify-end gap-2">
      <button id="dupClose" class="rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">
        OK
      </button>
    </div>
  </div>
</div>
    
    <script>
      /* ----------------- Helpers ----------------- */

      function openDupModal(message) {
  const m = document.getElementById("dupModal");
  const msg = document.getElementById("dupMsg");
  if (message) msg.textContent = message;
  m.classList.remove("hidden");
}
function closeDupModal() {
  document.getElementById("dupModal").classList.add("hidden");
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("dupClose");
  if (btn) btn.addEventListener("click", closeDupModal);

  // ถ้ามี dup=1 ใน query ให้เปิด modal
  const params = new URLSearchParams(location.search);
  if (params.get("dup") === "1") {
    openDupModal(params.get("msg") || "You already have a booking at this time.");
  }
});
  function lockPastDates(dateInput) {
  // คืนค่า YYYY-MM-DD ตามเวลาท้องถิ่น
  const todayISO = toISODateLocal(new Date());

  // ตั้ง min (และ max 90 วันข้างหน้า เพื่อ UX)
  dateInput.min = todayISO;
  const max = new Date();
  max.setDate(max.getDate() + 90);
  dateInput.max = toISODateLocal(max);

  // ถ้าค่าเดิมย้อนหลัง → ดันกลับมาวันนี้
  if (dateInput.value && dateInput.value < todayISO) {
    dateInput.value = todayISO;
  }

  // ป้องกันการพิมพ์ย้อนหลังเอง
  dateInput.addEventListener("change", (e) => {
    if (e.target.value && e.target.value < dateInput.min) {
      e.target.value = dateInput.min;
    }
  });

  // บางเบราว์เซอร์อ่าน min ตอนเปิดปฏิทินครั้งแรก
  // อัปเดต min ทุกครั้งที่ focus/คลิก เพื่อกัน timezone shift
  const refreshMin = () => {
    const nowISO = toISODateLocal(new Date());
    dateInput.min = nowISO;
    if (dateInput.value && dateInput.value < nowISO) {
      dateInput.value = nowISO;
    }
  };
  dateInput.addEventListener("focus", refreshMin);
  dateInput.addEventListener("click", refreshMin);
}
      function qp(key){ return new URLSearchParams(location.search).get(key)||""; }
      function toISODateLocal(d){ const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }
      function parseISODate(s){ const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
      function weekdayKeyFromDateStr(iso){ return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][parseISODate(iso).getDay()]; }

      /* ----------------- Normalizers ----------------- */
      function normalizeDayToAbbrev(token){
        if(!token) return "";
        const t=token.toString().trim().toLowerCase();
        const map={sun:"Sun",sunday:"Sun",mon:"Mon",monday:"Mon",tue:"Tue",tues:"Tue",tuesday:"Tue",wed:"Wed",weds:"Wed",wednesday:"Wed",thu:"Thu",thur:"Thu",thurs:"Thu",thursday:"Thu",fri:"Fri",friday:"Fri",sat:"Sat",saturday:"Sat"};
        return map[t]||map[t.slice(0,3)]||"";
      }

      /* ----------------- Fetch (only /api/trainers) ----------------- */
      async function fetchTrainers(){
        const r=await fetch("/api/trainers",{ headers:{ Accept:"application/json" } });
        if(!r.ok) throw new Error(`/api/trainers → ${r.status}`);
        return r.json();
      }

      /* ----------------- Build schedule (robust) ----------------- */
      function buildWeekSchedule(trainer){
        const sched={}; if(!trainer) return sched;

        // รับได้ทั้ง Array หรือ String(JSON)
        let arr=[];
        const raw=trainer.schedule;
        if(Array.isArray(raw)) arr=raw;
        else if(typeof raw==="string"){
          try{ arr=JSON.parse(raw); }catch{ arr=[]; }
        }

        arr.forEach(slotRaw=>{
          if(typeof slotRaw!=="string") return;
          // แปลง en dash/em dash/minus → hyphen และจัดช่องว่าง
          const s=slotRaw.replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g,"-").replace(/\s+/g," ").trim();

          // ยอมรับ "Mon 09:00-11:00" หรือ "Monday 09:00-11:00"
          const m=s.match(/^([A-Za-z]+)\s+([0-2]\d:[0-5]\d)\s*-\s*([0-2]\d:[0-5]\d)$/);
          if(!m) return;

          const day=normalizeDayToAbbrev(m[1]);
          if(!day) return;

          const timeStr=`${m[2]}-${m[3]}`;
          if(!sched[day]) sched[day]=[];
          sched[day].push(timeStr);
        });

        return sched;
      }

      /* ----------------- UI fillers ----------------- */
      function refreshTimeOptionsForDate(sched, isoDate){
        const timeSel=document.getElementById("timeSlot");
        const note=document.getElementById("scheduleNote");
        const btn=document.getElementById("bookBtn");

        timeSel.innerHTML='<option value="">Choose a time</option>';

        if(!isoDate){
          note.textContent="Please pick a date.";
          btn.disabled=true; return;
        }
        const wk=weekdayKeyFromDateStr(isoDate);
        const slots=sched[wk]||[];

        if(slots.length){
          slots.forEach(t=>{
            const opt=document.createElement("option");
            opt.value=t; opt.textContent=t;
            timeSel.appendChild(opt);
          });
          note.textContent=`Available on ${wk}: ${slots.join(", ")}`;
          btn.disabled=false;
        }else{
          note.textContent="No classes on this day.";
          btn.disabled=true;
        }
      }

      function getFirstAvailableDate(sched, maxDays=90){
        const today=new Date();
        for(let i=0;i<maxDays;i++){
          const d=new Date(today);
          d.setDate(today.getDate()+i);
          const iso=toISODateLocal(d);
          const wk=weekdayKeyFromDateStr(iso);
          if(sched[wk] && sched[wk].length) return iso;
        }
        return "";
      }

      /* ----------------- Main load ----------------- */
      async function loadScheduleAndRefresh(trainerName, preferredISO, preferredTime){
        let sched={};
        try{
          const trainers=await fetchTrainers();
          const trainer=trainers.find(t=>t.name===trainerName);
          sched=buildWeekSchedule(trainer);
        }catch(e){
          // ถ้าโหลดไม่ได้ ให้โชว์ข้อความ และปิดปุ่ม
          const note=document.getElementById("scheduleNote");
          note.textContent="Cannot load trainers from /api/trainers.";
          note.classList.add("text-red-600");
          document.getElementById("bookBtn").disabled=true;
          return;
        }

        // เลือกวันเริ่มต้น
        let defaultISO=preferredISO;
        if(defaultISO){
          const wk=weekdayKeyFromDateStr(defaultISO);
          if(!sched[wk] || !sched[wk].length) defaultISO="";
        }
        if(!defaultISO) defaultISO=getFirstAvailableDate(sched,90);

       const dateInput = document.getElementById("date");

       // ถ้า preferredISO อยู่ในอดีต ให้ตัดทิ้ง
        const todayISO = toISODateLocal(new Date());
        if (defaultISO && defaultISO < todayISO) defaultISO = "";

        // เซ็ตค่าและ "ล็อกไม่ให้เลือกย้อนหลัง"
        dateInput.value = defaultISO || todayISO;
        lockPastDates(dateInput);

        refreshTimeOptionsForDate(sched, dateInput.value);

        // ใส่เวลาที่มากับ query ถ้าตรง
        if(preferredTime){
          const sel=document.getElementById("timeSlot");
          const has=Array.from(sel.options).some(o=>o.value===preferredTime);
          if(has) sel.value=preferredTime;
        }

        dateInput.onchange=(e)=>refreshTimeOptionsForDate(sched,e.target.value);
      }

      /* ----------------- Init ----------------- */
      document.addEventListener("DOMContentLoaded", async ()=>{
        const trainerSelect=document.getElementById("trainer");

        let trainerName=qp("trainer");
        let className=qp("class");
        let price=qp("price");
        let dateQ=qp("date");
        let timeQ=qp("time");
        let classId=qp("classId");

        // ตั้งค่าเริ่มต้น
        if(trainerName){
          const opt=Array.from(trainerSelect.options).find(o=>o.value===trainerName);
          if(opt){
            trainerSelect.value=trainerName;
            document.getElementById("trainerId").value=opt.getAttribute("data-id")||"";
          }
        }else{
          document.getElementById("trainerId").value=trainerSelect.selectedOptions[0].getAttribute("data-id")||"";
          trainerName=trainerSelect.value;
        }

        document.getElementById("class").value=className||"";
        document.getElementById("price").value=price||"";
        document.getElementById("classId").value=classId||"";

        // เมื่อเปลี่ยนเทรนเนอร์
        trainerSelect.addEventListener("change", async (e)=>{
          const opt=e.target.selectedOptions[0];
          document.getElementById("trainerId").value=opt.getAttribute("data-id")||"";
          await loadScheduleAndRefresh(opt.value,"","");
          document.getElementById("timeSlot").value="";
        });

        // โหลดครั้งแรก
        await loadScheduleAndRefresh(trainerName, dateQ, timeQ);
      });
    </script>
  </body>
</html>
